name: Deploy Portfolio to Beget

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - '**/*.md'
      - '!**/INSTALLATION_GUIDE.md'
      - '!**/NEXT_STEPS.md'
      - '!**/TROUBLESHOOTING.md'
      - '!**/CHECK_WORKFLOW_STATUS.md'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        continue-on-error: false

      - name: Prepare files for deployment
        run: |
          echo "üì¶ Preparing files for deployment..."
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑ public
          if [ -d "public" ] && [ "$(ls -A public)" ]; then
            echo "üìÅ Copying public files..."
            cp -r public/* dist/ || true
          fi
          
          # –ö–æ–ø–∏—Ä—É–µ–º –∫–∞—Ç–∞–ª–æ–≥ favicon –≤ –∫–æ—Ä–µ–Ω—å dist (—á—Ç–æ–±—ã –±—ã–ª –≤ –∫–æ—Ä–Ω–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
          if [ -d "public/favicon" ]; then
            echo "üìÅ Copying favicon directory to root..."
            cp -r public/favicon dist/favicon || true
            echo "‚úÖ Favicon directory copied to dist/favicon"
            echo "üìÅ Favicon directory contents:"
            ls -la dist/favicon/ || true
          else
            echo "‚ö†Ô∏è public/favicon directory not found"
          fi

          # –ö–æ–ø–∏—Ä—É–µ–º PHP API —Ñ–∞–π–ª—ã
          echo "üìÑ Copying PHP API files..."
          mkdir -p dist/api
          cp -r api/*.php dist/api/ || true
          # –£–¥–∞–ª—è–µ–º config.php –∏–∑ dist, –æ–Ω –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
          rm -f dist/api/config.php || true
          
          # –ö–æ–ø–∏—Ä—É–µ–º admin API —Ñ–∞–π–ª—ã
          echo "üìÑ Copying admin API files..."
          mkdir -p dist/api/admin
          if [ -d "api/admin" ] && [ "$(ls -A api/admin 2>/dev/null)" ]; then
            cp -r api/admin/*.php dist/api/admin/ || true
            # –ò—Å–∫–ª—é—á–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
            rm -f dist/api/admin/seed-projects.php || true
            echo "‚úÖ Admin API files copied"
          else
            echo "‚ö†Ô∏è No admin API files found"
          fi
          
          # –ö–æ–ø–∏—Ä—É–µ–º database —Ñ–∞–π–ª—ã (–±–µ–∑ config.php)
          echo "üìÅ Copying database files..."
          mkdir -p dist/database
          cp database/schema.sql dist/database/ || true
          cp database/install.sql dist/database/ || true
          cp database/seed-projects.sql dist/database/ || true
          cp database/.gitignore dist/database/ || true
          cp database/README.md dist/database/ || true
          # config.php –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
          
          # HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É–∂–µ —Å–æ–±—Ä–∞–Ω—ã Vite –≤ dist/pages/
          # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∏—Ö –≤ –∫–æ—Ä–µ–Ω—å –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö URL
          echo "üìÑ Moving page HTML files to root..."
          if [ -f "dist/pages/admin.html" ]; then
            cp dist/pages/admin.html dist/admin.html
            echo "‚úÖ admin.html copied to root"
          fi
          if [ -f "dist/pages/testimonial-form.html" ]; then
            cp dist/pages/testimonial-form.html dist/testimonial-form.html
            echo "‚úÖ testimonial-form.html copied to root"
          fi
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–æ–∫
          echo "üìÅ Creating upload directories..."
          mkdir -p dist/uploads/projects
          mkdir -p dist/uploads/site
          mkdir -p dist/uploads/testimonials
          
          # –°–æ–∑–¥–∞–µ–º .gitkeep —Ñ–∞–π–ª—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
          touch dist/uploads/projects/.gitkeep
          touch dist/uploads/site/.gitkeep
          touch dist/uploads/testimonials/.gitkeep
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)
          chmod -R 755 dist/uploads/ || true
          
          echo "‚úÖ Upload directories created"
          echo "üìÅ Upload directories structure:"
          ls -la dist/uploads/ || true
          ls -la dist/uploads/projects/ || true
          ls -la dist/uploads/site/ || true
          ls -la dist/uploads/testimonials/ || true

          echo "‚úÖ Files prepared for deployment"
          echo "üìÅ Contents of dist:"
          ls -la dist/ || true
          echo "üìÅ Contents of dist/api:"
          ls -la dist/api/ || true
          echo "üìÅ Contents of dist/database:"
          ls -la dist/database/ || true

      - name: Create database config from secrets
        run: |
          echo "üîê Creating database config from secrets..."
          mkdir -p dist/database
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–∫—Ä–µ—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–¥–∞–Ω—ã, –∏–Ω–∞—á–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          DB_USERNAME="${{ secrets.FTP_DB_USERNAME }}"
          DB_PASSWORD="${{ secrets.FTP_DB_PASSWORD }}"
          
          # –ï—Å–ª–∏ —Å–µ–∫—Ä–µ—Ç—ã –Ω–µ –∑–∞–¥–∞–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          if [ -z "$DB_USERNAME" ]; then
            DB_USERNAME="nikolr4t_portfol"
            echo "‚ö†Ô∏è Using default username: nikolr4t_portfol"
            echo "üí° Tip: Set FTP_DB_USERNAME secret if username differs"
          fi
          
          if [ -z "$DB_PASSWORD" ]; then
            DB_PASSWORD="4I3%8gC2QF86"
            echo "‚ö†Ô∏è Using default password"
            echo "üí° Tip: Set FTP_DB_PASSWORD secret for security"
          fi
          
          cat > dist/database/config.php << EOF
          <?php
          /**
           * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
           * ‚ö†Ô∏è –í–ê–ñ–ù–û: –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ
           */
          
          return [
              'host' => 'localhost',
              'dbname' => 'nikolr4t_portfol',
              'username' => '$DB_USERNAME',
              'password' => '$DB_PASSWORD',
              'charset' => 'utf8mb4',
          ];
          EOF
          echo "‚úÖ Database config created"
          echo "üìù Username: $DB_USERNAME"

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: Create API config from secrets
        run: |
          echo "üîê Creating API config from secrets..."
          mkdir -p dist/api
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤
          if [ -z "${{ secrets.FTP_ADMIN_PASSWORD }}" ]; then
            echo "‚ö†Ô∏è WARNING: FTP_ADMIN_PASSWORD secret is not set"
          fi
          if [ -z "${{ secrets.FTP_BOT_TOKEN }}" ]; then
            echo "‚ö†Ô∏è WARNING: FTP_BOT_TOKEN secret is not set"
          fi
          if [ -z "${{ secrets.FTP_CHAT_ID }}" ]; then
            echo "‚ö†Ô∏è WARNING: FTP_CHAT_ID secret is not set"
          fi
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º hash –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ PHP
          ADMIN_PASSWORD_HASH=$(php -r "echo password_hash('${{ secrets.FTP_ADMIN_PASSWORD }}', PASSWORD_DEFAULT);")
          
          # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏
          BOT_TOKEN="${{ secrets.FTP_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.FTP_CHAT_ID }}"
          
          # –°–æ–∑–¥–∞–µ–º config.php —Å –ø—Ä—è–º–æ–π –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          cat > dist/api/config.php << EOF
          <?php
          /**
           * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
           * ‚ö†Ô∏è –í–ê–ñ–ù–û: –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ –∏–∑ GitHub Secrets
           */
          
          // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ë–î
          \$dbConfig = require __DIR__ . '/../database/config.php';
          
          // Telegram Bot –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
          define('TELEGRAM_BOT_TOKEN', '${BOT_TOKEN}');
          define('TELEGRAM_CHAT_ID', '${CHAT_ID}');
          
          // Email –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
          define('ADMIN_EMAIL', 'nikwebdev.2025@gmail.com');
          
          // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
          define('ADMIN_PASSWORD_HASH', '${ADMIN_PASSWORD_HASH}');
          
          // CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
          header('Access-Control-Allow-Origin: *');
          header('Access-Control-Allow-Methods: POST, GET, OPTIONS');
          header('Access-Control-Allow-Headers: Content-Type');
          header('Content-Type: application/json; charset=utf-8');
          
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ preflight –∑–∞–ø—Ä–æ—Å–æ–≤
          if (\$_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
              http_response_code(200);
              exit;
          }
          EOF
          
          echo "‚úÖ API config created with secrets"

      - name: Verify files before deployment
        run: |
          echo "üîç Verifying files before deployment..."
          echo "üìÅ Checking dist structure:"
          find dist -type f -name "*.php" | head -10
          echo ""
          echo "üìÅ Checking HTML files:"
          find dist -type f -name "*.html"
          echo ""
          echo "üìÅ Checking config files:"
          test -f dist/database/config.php && echo "‚úÖ database/config.php exists" || echo "‚ùå database/config.php missing"
          test -f dist/api/config.php && echo "‚úÖ api/config.php exists" || echo "‚ùå api/config.php missing"
          echo ""
          echo "üìÅ Checking admin API files:"
          test -f dist/api/admin/get-projects.php && echo "‚úÖ api/admin/get-projects.php exists" || echo "‚ùå api/admin/get-projects.php missing"
          test -f dist/api/admin/seed-initial-projects.php && echo "‚úÖ api/admin/seed-initial-projects.php exists" || echo "‚ùå api/admin/seed-initial-projects.php missing"
          test -f dist/api/admin/save-project.php && echo "‚úÖ api/admin/save-project.php exists" || echo "‚ùå api/admin/save-project.php missing"
          test -f dist/api/admin/delete-project.php && echo "‚úÖ api/admin/delete-project.php exists" || echo "‚ùå api/admin/delete-project.php missing"
          test -f dist/api/admin/save-site-setting.php && echo "‚úÖ api/admin/save-site-setting.php exists" || echo "‚ùå api/admin/save-site-setting.php missing"
          echo ""
          echo "üìÅ Admin API files list:"
          ls -la dist/api/admin/ 2>/dev/null || echo "‚ö†Ô∏è dist/api/admin/ directory not found"

      - name: Deploy to Beget via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          protocol: ftp
          dangerous-clean-slate: false
          dry-run: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store
            **/Thumbs.db
            **/*.md
            **/.github/**
            **/.vscode/**
            **/.idea/**
          log-level: verbose
          state-name: .ftp-deploy-sync-state.json

      - name: Verify deployment
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment completed successfully!"
            echo "üåê Your portfolio should be available at https://develonik.ru"
            echo "üìù Files deployed:"
            echo "  - Frontend: dist/*"
            echo "  - API: dist/api/*.php"
            echo "  - Admin API: dist/api/admin/*.php"
            echo "  - Database config: dist/database/config.php"
            echo "  - API config: dist/api/config.php (with secrets)"
          echo ""
            echo "üîç Next steps:"
            echo "  1. Check https://develonik.ru/"
            echo "  2. Check https://develonik.ru/admin.html"
            echo "  3. Check https://develonik.ru/api/test-db.php"
            echo "  4. Check https://develonik.ru/api/admin/get-projects.php (after login)"
          else
            echo "‚ùå Deployment failed!"
            echo "Please check the logs above for errors."
            exit 1
          fi
