name: Deploy Portfolio to Beget

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - '*.md'
      - '.github/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        continue-on-error: false

      - name: Prepare files for deployment
        run: |
          echo "ðŸ“¦ Preparing files for deployment..."
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· public
          if [ -d "public" ] && [ "$(ls -A public)" ]; then
            echo "ðŸ“ Copying public files..."
            cp -r public/* dist/ || true
          fi
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ PHP API Ñ„Ð°Ð¹Ð»Ñ‹
          echo "ðŸ“„ Copying PHP API files..."
          mkdir -p dist/api
          cp -r api/*.php dist/api/ || true
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ config.php Ð¸Ð· dist, Ð¾Ð½ Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
          rm -f dist/api/config.php || true
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ database Ñ„Ð°Ð¹Ð»Ñ‹ (Ð±ÐµÐ· config.php)
          echo "ðŸ“ Copying database files..."
          mkdir -p dist/database
          cp database/schema.sql dist/database/ || true
          cp database/install.sql dist/database/ || true
          cp database/.gitignore dist/database/ || true
          cp database/README.md dist/database/ || true
          # config.php Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ HTML ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
          if [ -d "src/pages" ]; then
            echo "ðŸ“„ Copying page files..."
            mkdir -p dist/pages
            cp src/pages/*.html dist/pages/ || true
          fi
          
          echo "âœ… Files prepared for deployment"
          echo "ðŸ“ Contents of dist:"
          ls -la dist/ || true
          echo "ðŸ“ Contents of dist/api:"
          ls -la dist/api/ || true
          echo "ðŸ“ Contents of dist/database:"
          ls -la dist/database/ || true

      - name: Create database config from secrets
        run: |
          echo "ðŸ” Creating database config from secrets..."
          mkdir -p dist/database
          cat > dist/database/config.php << 'EOF'
          <?php
          /**
           * ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
           * âš ï¸ Ð’ÐÐ–ÐÐž: Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ðµ
           */
          
          return [
              'host' => 'localhost',
              'dbname' => 'nikolr4t_portfol',
              'username' => 'nikolr4t',
              'password' => '4I3%8gC2QF86',
              'charset' => 'utf8mb4',
          ];
          EOF
          echo "âœ… Database config created"

      - name: Create API config from secrets
        run: |
          echo "ðŸ” Creating API config from secrets..."
          mkdir -p dist/api
          
          # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ hash Ð¿Ð°Ñ€Ð¾Ð»Ñ
          ADMIN_PASSWORD_HASH=$(php -r "echo password_hash('${{ secrets.FTP_ADMIN_PASSWORD }}', PASSWORD_DEFAULT);")
          
          cat > dist/api/config.php << EOF
          <?php
          /**
           * ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ API
           * âš ï¸ Ð’ÐÐ–ÐÐž: Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ðµ Ð¸Ð· GitHub Secrets
           */
          
          // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð‘Ð”
          \$dbConfig = require __DIR__ . '/../database/config.php';
          
          // Telegram Bot Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
          define('TELEGRAM_BOT_TOKEN', '${{ secrets.FTP_BOT_TOKEN }}');
          define('TELEGRAM_CHAT_ID', '${{ secrets.FTP_CHAT_ID }}');
          
          // Email Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
          define('ADMIN_EMAIL', 'nikwebdev.2025@gmail.com');
          
          // ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
          define('ADMIN_PASSWORD_HASH', '$ADMIN_PASSWORD_HASH');
          
          // CORS Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
          header('Access-Control-Allow-Origin: *');
          header('Access-Control-Allow-Methods: POST, GET, OPTIONS');
          header('Access-Control-Allow-Headers: Content-Type');
          header('Content-Type: application/json; charset=utf-8');
          
          // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° preflight Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
          if (\$_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
              http_response_code(200);
              exit;
          }
          EOF
          echo "âœ… API config created with secrets"

      - name: Deploy to Beget via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/
          server-dir: ${{ secrets.FTP_SERVER_DIR || '/public_html/' }}
          protocol: ftp
          dangerous-clean-slate: false
          dry-run: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store
            **/Thumbs.db
            **/*.md
            **/.github/**
            **/.vscode/**
            **/.idea/**
          log-level: verbose
          state-name: .ftp-deploy-sync-state.json

      - name: Verify deployment
        if: success()
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ Your portfolio should be available at https://develonik.ru"
          echo "ðŸ“ Files deployed:"
          echo "  - Frontend: dist/*"
          echo "  - API: dist/api/*.php"
          echo "  - Database config: dist/database/config.php"
          echo "  - API config: dist/api/config.php (with secrets)"
