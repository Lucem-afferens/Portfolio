name: Deploy Portfolio to Beget

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - '**/*.md'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        continue-on-error: false

      - name: Prepare files for deployment
        run: |
          echo "ðŸ“¦ Preparing files for deployment..."
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· public
          if [ -d "public" ] && [ "$(ls -A public)" ]; then
            echo "ðŸ“ Copying public files..."
            cp -r public/* dist/ || true
          fi
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ PHP API Ñ„Ð°Ð¹Ð»Ñ‹
          echo "ðŸ“„ Copying PHP API files..."
          mkdir -p dist/api
          cp -r api/*.php dist/api/ || true
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ config.php Ð¸Ð· dist, Ð¾Ð½ Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
          rm -f dist/api/config.php || true
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ database Ñ„Ð°Ð¹Ð»Ñ‹ (Ð±ÐµÐ· config.php)
          echo "ðŸ“ Copying database files..."
          mkdir -p dist/database
          cp database/schema.sql dist/database/ || true
          cp database/install.sql dist/database/ || true
          cp database/.gitignore dist/database/ || true
          cp database/README.md dist/database/ || true
          # config.php Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
          
          # HTML ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ ÑƒÐ¶Ðµ ÑÐ¾Ð±Ñ€Ð°Ð½Ñ‹ Vite Ð² dist/pages/
          # ÐŸÐµÑ€ÐµÐ¼ÐµÑ‰Ð°ÐµÐ¼ Ð¸Ñ… Ð² ÐºÐ¾Ñ€ÐµÐ½ÑŒ Ð´Ð»Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ñ… URL
          echo "ðŸ“„ Moving page HTML files to root..."
          if [ -f "dist/pages/admin.html" ]; then
            cp dist/pages/admin.html dist/admin.html
            echo "âœ… admin.html copied to root"
          fi
          if [ -f "dist/pages/testimonial-form.html" ]; then
            cp dist/pages/testimonial-form.html dist/testimonial-form.html
            echo "âœ… testimonial-form.html copied to root"
          fi
          
          echo "âœ… Files prepared for deployment"
          echo "ðŸ“ Contents of dist:"
          ls -la dist/ || true
          echo "ðŸ“ Contents of dist/api:"
          ls -la dist/api/ || true
          echo "ðŸ“ Contents of dist/database:"
          ls -la dist/database/ || true

      - name: Create database config from secrets
        run: |
          echo "ðŸ” Creating database config from secrets..."
          mkdir -p dist/database
          
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÐµÐºÑ€ÐµÑ‚Ñ‹, ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ Ð·Ð°Ð´Ð°Ð½Ñ‹, Ð¸Ð½Ð°Ñ‡Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
          DB_USERNAME="${{ secrets.FTP_DB_USERNAME }}"
          DB_PASSWORD="${{ secrets.FTP_DB_PASSWORD }}"
          
          # Ð•ÑÐ»Ð¸ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð½Ðµ Ð·Ð°Ð´Ð°Ð½Ñ‹, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
          if [ -z "$DB_USERNAME" ]; then
            DB_USERNAME="nikolr4t"
            echo "âš ï¸ Using default username: nikolr4t"
            echo "ðŸ’¡ Tip: Set FTP_DB_USERNAME secret if username differs"
          fi
          
          if [ -z "$DB_PASSWORD" ]; then
            DB_PASSWORD="4I3%8gC2QF86"
            echo "âš ï¸ Using default password"
            echo "ðŸ’¡ Tip: Set FTP_DB_PASSWORD secret for security"
          fi
          
          cat > dist/database/config.php << EOF
          <?php
          /**
           * ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
           * âš ï¸ Ð’ÐÐ–ÐÐž: Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ðµ
           */
          
          return [
              'host' => 'localhost',
              'dbname' => 'nikolr4t_portfol',
              'username' => '$DB_USERNAME',
              'password' => '$DB_PASSWORD',
              'charset' => 'utf8mb4',
          ];
          EOF
          echo "âœ… Database config created"
          echo "ðŸ“ Username: $DB_USERNAME"

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: Create API config from secrets
        run: |
          echo "ðŸ” Creating API config from secrets..."
          mkdir -p dist/api
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
          if [ -z "${{ secrets.FTP_ADMIN_PASSWORD }}" ]; then
            echo "âš ï¸ WARNING: FTP_ADMIN_PASSWORD secret is not set"
          fi
          if [ -z "${{ secrets.FTP_BOT_TOKEN }}" ]; then
            echo "âš ï¸ WARNING: FTP_BOT_TOKEN secret is not set"
          fi
          if [ -z "${{ secrets.FTP_CHAT_ID }}" ]; then
            echo "âš ï¸ WARNING: FTP_CHAT_ID secret is not set"
          fi
          
          # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ hash Ð¿Ð°Ñ€Ð¾Ð»Ñ Ñ‡ÐµÑ€ÐµÐ· PHP
          ADMIN_PASSWORD_HASH=$(php -r "echo password_hash('${{ secrets.FTP_ADMIN_PASSWORD }}', PASSWORD_DEFAULT);")
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ config.php Ñ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¾Ð¹ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
          cat > dist/api/config.php << 'ENDOFFILE'
          <?php
          /**
           * ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ API
           * âš ï¸ Ð’ÐÐ–ÐÐž: Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ðµ Ð¸Ð· GitHub Secrets
           */
          
          // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð‘Ð”
          $dbConfig = require __DIR__ . '/../database/config.php';
          
          // Telegram Bot Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
          define('TELEGRAM_BOT_TOKEN', '${{ secrets.FTP_BOT_TOKEN }}');
          define('TELEGRAM_CHAT_ID', '${{ secrets.FTP_CHAT_ID }}');
          
          // Email Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
          define('ADMIN_EMAIL', 'nikwebdev.2025@gmail.com');
          
          // ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
          define('ADMIN_PASSWORD_HASH', '$ADMIN_PASSWORD_HASH');
          
          // CORS Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
          header('Access-Control-Allow-Origin: *');
          header('Access-Control-Allow-Methods: POST, GET, OPTIONS');
          header('Access-Control-Allow-Headers: Content-Type');
          header('Content-Type: application/json; charset=utf-8');
          
          // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° preflight Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
          if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
              http_response_code(200);
              exit;
          }
          ENDOFFILE
          
          # Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð² Ñ„Ð°Ð¹Ð»Ðµ
          sed -i "s|\${{ secrets.FTP_BOT_TOKEN }}|${{ secrets.FTP_BOT_TOKEN }}|g" dist/api/config.php
          sed -i "s|\${{ secrets.FTP_CHAT_ID }}|${{ secrets.FTP_CHAT_ID }}|g" dist/api/config.php
          sed -i "s|\$ADMIN_PASSWORD_HASH|$ADMIN_PASSWORD_HASH|g" dist/api/config.php
          
          echo "âœ… API config created with secrets"

      - name: Verify files before deployment
        run: |
          echo "ðŸ” Verifying files before deployment..."
          echo "ðŸ“ Checking dist structure:"
          find dist -type f -name "*.php" | head -10
          echo ""
          echo "ðŸ“ Checking HTML files:"
          find dist -type f -name "*.html"
          echo ""
          echo "ðŸ“ Checking config files:"
          test -f dist/database/config.php && echo "âœ… database/config.php exists" || echo "âŒ database/config.php missing"
          test -f dist/api/config.php && echo "âœ… api/config.php exists" || echo "âŒ api/config.php missing"

      - name: Deploy to Beget via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          protocol: ftp
          dangerous-clean-slate: false
          dry-run: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store
            **/Thumbs.db
            **/*.md
            **/.github/**
            **/.vscode/**
            **/.idea/**
          log-level: verbose
          state-name: .ftp-deploy-sync-state.json

      - name: Verify deployment
        if: success()
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ Your portfolio should be available at https://develonik.ru"
          echo "ðŸ“ Files deployed:"
          echo "  - Frontend: dist/*"
          echo "  - API: dist/api/*.php"
          echo "  - Database config: dist/database/config.php"
          echo "  - API config: dist/api/config.php (with secrets)"
          echo ""
          echo "ðŸ” Next steps:"
          echo "  1. Check https://develonik.ru/"
          echo "  2. Check https://develonik.ru/admin.html"
          echo "  3. Check https://develonik.ru/api/test-db.php"
